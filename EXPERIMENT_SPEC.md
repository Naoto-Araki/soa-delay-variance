# SoA逐次計測実験 - 実験仕様書

## 1. 実験概要

### 目的
Sense of Agency (SoA; 主体感) の時間的変容を逐次的に計測し、聴覚フィードバックの遅延がSoA学習に与える影響を検証する。

### 基礎文献
Bamba et al. (2020) の実験課題をベースに、評価方法を試行後質問紙から試行ごとのデジタル評定に変更。

---

## 2. 実験条件（3条件間比較）

### Condition A（対照群）
- **Step 2（Intervention）の遅延**: なし
- **条件付け時の音の遅延**: 0 ms
- **SoA評定時の音の遅延**: 0 ms
- **目的**: ベースライン比較

### Condition B（学習阻害条件）
- **Step 2（Intervention）の遅延**: あり
- **条件付け時の音の遅延**: μ_delay ms（例: 200 ms）
- **SoA評定時の音の遅延**: 0 ms
- **仮説**: 条件付けで遅延を経験するが、評定時は遅延なし → 学習が妨げられる

### Condition C（学習促進条件）
- **Step 2（Intervention）の遅延**: あり
- **条件付け時の音の遅延**: μ_delay ms（例: 200 ms）
- **SoA評定時の音の遅延**: μ_delay ms（例: 200 ms）
- **仮説**: 条件付けと評定で同じ遅延 → 学習が促進される

---

## 3. 実験構造（60試行）

### Step 1: Baseline（試行 1-20）
- **目的**: 遅延なしでのベースラインSoA測定
- **条件付け遅延**: 0 ms
- **評定遅延**: 0 ms
- **全条件共通**

### Step 2: Intervention（試行 21-40）
- **目的**: 遅延による介入（条件A/B/Cで異なる）
- **条件付け遅延**: 条件により0 msまたはμ_delay ms
- **評定遅延**: 条件により0 msまたはμ_delay ms

### Step 3: Washout（試行 41-60）
- **目的**: 介入後の持続効果測定
- **条件付け遅延**: 0 ms
- **評定遅延**: 0 ms
- **全条件共通**

**注意**: 被験者にはステップの切り替わりを伝えない（休憩なし・連続実施）

---

## 4. 1試行の流れ

### 4.1 試行間インターバル（0.5秒）
- 黒背景に白い水平バーとオレンジのゴール領域を表示
- 赤いカーソルは常にマウス位置に追従

### 4.2 条件付けフェーズ（Action & Feedback）

#### ① 動作遂行（Action）
1. 参加者がマウスで赤いカーソルを右端のオレンジ領域まで移動
2. オレンジ領域に到達したらクリック
3. クリック時刻を記録

#### ② フィードバック（Feedback）
1. クリック後、`task_delay` ms 待機（画面更新は継続）
2. 440 Hz、50 ms のビープ音を再生
3. 音の再生時刻を記録
4. 音が鳴った後、0.5秒間画面表示を維持

#### ③ ブラックアウト
1. 500 ms の黒画面を表示
2. この間、マウスカーソルを画面中央（0, 0）に強制移動（毎フレーム）
3. ブラックアウト後、カーソル位置を明示的に中央に設定

### 4.3 SoA評定フェーズ（Immediate Rating）

#### ① VAS評定画面表示
- **質問文**: 「音が自分のクリックによって鳴ったと感じた程度を評定してください」
- **スケール**: 0%（他者/非主体）〜 100%（自分/主体）
- **目盛り**: 10%刻みで表示（10, 20, 30, ..., 90）、50は大きく表示
- **カーソル**: 赤い縦線（マウス位置に追従）
- **初期位置**: 50%（中央）

#### ② 評定入力
1. 参加者がマウスでカーソルを移動
2. 決定したい位置でクリック
3. 評定値（0-100）を記録

#### ③ 聴覚フィードバック
1. クリック後、`ans_delay` ms 待機（VAS画面表示継続）
2. 440 Hz、50 ms のビープ音を再生
3. 音が鳴った後、0.5秒間VAS画面表示を維持

#### ④ ブラックアウト
1. 500 ms の黒画面を表示
2. マウスカーソルを画面中央に強制移動（毎フレーム）
3. ブラックアウト後、次の試行の準備完了

---

## 5. 音刺激の仕様

### 音響特性
- **周波数**: 440 Hz（ラの音、A4）
- **波形**: サイン波
- **持続時間**: 50 ms
- **エンベロープ**: 立ち上がり/立ち下がり各5 ms
- **音圧レベル**: 74 dB SPL（実験前に騒音計で調整）
- **サンプルレート**: 44100 Hz
- **ビット深度**: 16 bit
- **音量設定**: プログラム内は最大値（1.0）

### 音量調整手順
1. プログラムを起動
2. 騒音計（小野測器社製 LA-1240 等）をスピーカー/ヘッドホン近くに配置
3. テスト音を再生しながらシステム音量を調整
4. 74 dB SPL になるように設定
5. 実験中は音量を変更しない

---

## 6. データ記録

### 記録項目（1試行あたり）

| 項目 | 説明 |
|------|------|
| `subject_id` | 参加者ID |
| `trial_number` | 試行番号（1-60） |
| `step` | フェーズ（Step1_Baseline / Step2_Intervention / Step3_Washout） |
| `condition` | 実験条件（A / B / C） |
| `mu_delay` | 遅延パラメータ（ms） |
| `task_delay_ms` | 条件付け時の実際の遅延時間（ms） |
| `ans_delay_ms` | 評定時の実際の遅延時間（ms） |
| `actual_action_time_s` | クリックから試行開始までの時間（秒） |
| `actual_sound_time_s` | 音の再生から試行開始までの時間（秒） |
| `soa_rating` | SoA評定値（0-100） |
| `timestamp` | 記録時刻（YYYY-MM-DD HH:MM:SS.ffffff） |

### ファイル名形式
```
data_continuous/{subject_id}_condition{A/B/C}_{YYYYMMDD_HHMMSS}.csv
```

**例**:
- `P001_conditionA_20260109_143022.csv`
- `P001_conditionB_20260109_150145.csv`
- `P001_conditionC_20260109_153308.csv`

---

## 7. 実験手順

### 7.1 実験前準備
1. 音量を74 dBに調整（騒音計使用）
2. 参加者に実験の概要を説明
   - 「マウスで赤いカーソルを右端まで動かしてクリックすると音が鳴る」
   - 「音が自分のクリックで鳴ったと感じた程度を毎回評定する」
   - **ステップの切り替わりについては説明しない**

### 7.2 実験開始
1. プログラムを起動: `python experiment_continuous_rating.py`
2. ダイアログで以下を入力:
   - 参加者ID（例: P001）
   - Condition（A / B / C）
   - 遅延パラメータ（例: 200 ms）
3. 教示画面を表示（スペースキーで開始）

### 7.3 本実験（60試行）
- 試行1-20: Baseline
- 試行21-40: Intervention（条件により遅延あり）
- 試行41-60: Washout
- **休憩なし・連続実施**

### 7.4 実験終了
1. 終了画面を表示
2. データを自動保存: `data_continuous/`フォルダ
3. 参加者への謝辞

---

## 8. データ分析・可視化

### 可視化スクリプト
```bash
# 特定のファイルをプロット
python plot_continuous_results.py data_continuous/P001_conditionA_20260109_143022.csv

# 全ファイルをプロット
python plot_continuous_results.py
```

### 出力グラフ
- **横軸**: Trial数（1-60）
- **縦軸**: SoA評定値（0-100）
- **色分け**: Step別（青=Baseline、赤=Intervention、緑=Washout）
- **トレンドライン**: 5試行移動平均
- **境界線**: 20試行目と40試行目に縦の点線

### 保存形式
- PNG形式、300 dpi
- ファイル名: `{元のCSVファイル名}_plot.png`

---

## 9. 実験上の注意点

### タイミングの精度
- 画面更新: 1-10 ms間隔で継続的に更新
- 音の再生: pygameによる低レイテンシ再生
- マウス位置: リアルタイム追従（遅延なし）

### ブラックアウトの役割
1. 試行間の視覚的区切り
2. マウス位置を確実に中央にリセット
3. 次の試行への準備時間

### カーソル挙動
- **条件付けフェーズ**: 常にマウス位置に追従
- **VAS評定フェーズ**: 常にマウス位置に追従（スケールの範囲内で制限）
- **ブラックアウト中**: 非表示

---

## 10. トラブルシューティング

### 音が聞こえない
- システム音量を確認
- pygameのインストールを確認: `pip list | grep pygame`
- オーディオデバイスの接続を確認

### カーソルが中央に戻らない
- 既に対策済み（毎フレームでリセット）
- それでも問題がある場合は、ブラックアウト時間を延長

### 実験が途中で停止
- ESCキーで終了していないか確認
- ターミナルのエラーメッセージを確認
- データは途中まで保存される

---

## 11. ファイル構成

```
soa-delay-variance/
├── experiment_continuous_rating.py  # メイン実験プログラム
├── plot_continuous_results.py       # 結果可視化スクリプト
├── EXPERIMENT_SPEC.md               # 本仕様書
├── README.md                        # プロジェクト概要
├── requirements.txt                 # 依存パッケージ
└── data_continuous/                 # データ保存先
    ├── P001_conditionA_*.csv
    ├── P001_conditionA_*_plot.png
    ├── P001_conditionB_*.csv
    ├── P001_conditionB_*_plot.png
    ├── P001_conditionC_*.csv
    └── P001_conditionC_*_plot.png
```

---

## 12. 実験デザインの理論的背景

### Condition Bの仮説（学習阻害）
- 条件付けフェーズで遅延を経験
- しかし評定時には遅延がない
- **予測**: 遅延への適応が評定で確認できず、学習が阻害される

### Condition Cの仮説（学習促進）
- 条件付けフェーズで遅延を経験
- 評定時にも同じ遅延
- **予測**: 一貫した遅延経験により、適応が強化される

### 予想される結果パターン
- **Condition A**: 全期間で高いSoA（遅延なし）
- **Condition B**: Step 2でSoA低下、Step 3で回復が遅い
- **Condition C**: Step 2でSoA低下するが、Step 3で素早く回復

---

## 変更履歴

- 2026-01-09: 初版作成
  - 実験仕様の全体整理
  - 3条件の詳細説明
  - 音刺激仕様の明記（74 dB SPL）
  - データ記録項目の整理
